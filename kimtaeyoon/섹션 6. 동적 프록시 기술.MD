# 동적 프록시 기술


### 1. JDK Dynamic Proxy
- RunTime 에 Interface 를 구현하는 프록시 객체를 동적으로 만들어내는 기술이다.
  Java 의 java.lang.reflect.Proxy 클래스를 통해 구현된다.

#### JPA Repository 인터페이스
- 우리가 이해하기 편한 것으로 연관된건 JPA Repository 가 있다.
- Spring Data JPA 의 JpaRepository 같은 인터페이스는 실제 구현체가 없으며, 런타임에 동적 프록시를 생성해 Repository 메소드를 실행 할 수 있도록 만든다.
- 이때, JDK 다이나믹 프록시를 통해  **인터페이스 기반의 프록시 객체**를 생성하고, 실제 구현체는 **`SimpleJpaRepository`**와 같은 Spring Data JPA의 기본 구현체가 처리한다.

```
public interface UserRepository extends JpaRepository<User, Long> {
}
```
- 위 코드에서 UserRepository 는 구현체가 없다. Spring이 동적 프록시 객체를 만들어 메소드를 처리한다.

#### JDK 동적 프록시가 동작하는 방식
- Spring 은 Proxy.newProxyInstance()를 사용해 인터페이스를 구현하는 프록시 객체를 생성한다.
- 프록시 객체는 메소드 호출을 가로채고 (InvocationHandler 통해), 이를 Spring 내부에서 처리하며, JDK 동적 프록시는 **반드시** 인터페이스 기반이다.
- 이때 UserRepository 는 프록시화가 되고, 실제 구현체는 SimpleJpaRepository와 같은 Spring Data JPA의 기본 구현체가 처리한다.

**findById 로 기본 JPA 메서드 사용 시 예)**
``` 
public Optional<T> findById(ID id) {
        Assert.notNull(id, "The given id must not be null");
        Class<T> domainType = this.getDomainClass();
        if (this.metadata == null) {
            return Optional.ofNullable(this.entityManager.find(domainType, id));
        } else {
            LockModeType type = this.metadata.getLockModeType();
            Map<String, Object> hints = this.getHints();
            return Optional.ofNullable(type == null ? this.entityManager.find(domainType, id, hints) : this.entityManager.find(domainType, id, type, hints));
        }
    }
```
***이과정에 의문이 들거다 InvocationHandler 로 잡기 위해 Proxy.newProxyInstance()를 통해 동적으로 생성한적이 없는데 어떻게 호출을 가로채서 스프링이 프록시 생성을 한건지.***
- 쭉 거슬러 올라가면 JpaRepository -> JpaRepositoryFactoryBean 와 연관이 있고,
JpaRepositoryFactoryBean 는 RepositoryFactoryBean 를 상속 받고 있으며 이를 통해, 동적 프록시 객체를 생성한다 이걸 통해 런타임시 Proxy.newProxyInstance()를 통해 프록시 객체를 생성하고
이후 생성된 프록시 객체는 SimpleJpaRepository의 실체 구현 메서드 호출을 하며, 데이터베이스와 상호작용한다

#### 간략히 설명하자면 RepositoryFactoryBean (또는 JpaRepositoryFactoryBean) 에서 Proxy.newProxyInstance() 사용해 프록시 객체를 생성하고 InvocationHandler 가 스프링 컨텍스트 생성 시 가로채서 실제 구현체인 SimpleJpaRepository 로 메소드를 전달한다.
- 즉, **RepositoryFactoryBean**이 프록시를 생성하고 JpaRepositoryFactoryBean의 경우 @EnableJpaRepositories을 통해 스프링이 알수있고, 이 프록시를 InvocationHandler 핸들러가 가로채는 구조이다.